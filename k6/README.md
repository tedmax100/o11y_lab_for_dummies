# K6 è² è¼‰æ¸¬è©¦è…³æœ¬

æœ¬ç›®éŒ„åŒ…å«é‡å° OpenTelemetry å¯è§€æ¸¬æ€§å¯¦é©—å®¤çš„ K6 è² è¼‰æ¸¬è©¦è…³æœ¬ã€‚

## ğŸ“‹ æ¸¬è©¦è…³æœ¬èªªæ˜

### 1. smoke-test.js - ç…™éœ§æ¸¬è©¦
**ç›®çš„**: é©—è­‰ç³»çµ±åŸºæœ¬åŠŸèƒ½æ˜¯å¦æ­£å¸¸

**ç‰¹é»**:
- ä½¿ç”¨ 1 å€‹è™›æ“¬ç”¨æˆ¶
- é‹è¡Œ 1 åˆ†é˜
- æ¸¬è©¦æ‰€æœ‰ä¸»è¦ç«¯é»
- åš´æ ¼çš„æ€§èƒ½é–¾å€¼

**ä½¿ç”¨å ´æ™¯**:
- éƒ¨ç½²å¾Œçš„å¿«é€Ÿé©—è­‰
- CI/CD æµç¨‹ä¸­çš„åŸºæœ¬æª¢æŸ¥
- é–‹ç™¼éšæ®µçš„åŠŸèƒ½é©—è­‰

**åŸ·è¡Œå‘½ä»¤**:
```bash
k6 run k6/smoke-test.js
```

---

### 2. load-test.js - è² è¼‰æ¸¬è©¦
**ç›®çš„**: æ¸¬è©¦ç³»çµ±åœ¨é æœŸè² è¼‰ä¸‹çš„æ€§èƒ½è¡¨ç¾

**ç‰¹é»**:
- å¤šéšæ®µè² è¼‰æ¨¡å¼ï¼ˆ5 â†’ 20 â†’ 50 ç”¨æˆ¶ï¼‰
- ç¸½é‹è¡Œæ™‚é–“ç´„ 3.5 åˆ†é˜
- åŒ…å«é ç†±ã€ç©©å®šã€å³°å€¼ã€å†·å»éšæ®µ
- è‡ªå®šç¾©æŒ‡æ¨™è¿½è¹¤

**ä½¿ç”¨å ´æ™¯**:
- æ€§èƒ½åŸºæº–æ¸¬è©¦
- å®¹é‡è¦åŠƒ
- è§€å¯Ÿç³»çµ±åœ¨ä¸åŒè² è¼‰ä¸‹çš„è¡¨ç¾

**åŸ·è¡Œå‘½ä»¤**:
```bash
k6 run k6/load-test.js
```

**è‡ªå®šç¾©åƒæ•¸**:
```bash
# æŒ‡å®šä¸åŒçš„ API Gateway åœ°å€
k6 run -e BASE_URL=http://your-gateway:8080 k6/load-test.js

# æŒ‡å®šä¸åŒçš„ Service A åœ°å€
k6 run -e SERVICE_A_URL=http://your-service-a:8001 k6/load-test.js
```

---

### 3. stress-test.js - å£“åŠ›æ¸¬è©¦
**ç›®çš„**: æ‰¾å‡ºç³»çµ±çš„æ€§èƒ½ç“¶é ¸å’Œæ¥µé™

**ç‰¹é»**:
- é€æ­¥å¢åŠ è² è¼‰ï¼ˆ10 â†’ 50 â†’ 100 â†’ 200 ç”¨æˆ¶ï¼‰
- ç¸½é‹è¡Œæ™‚é–“ç´„ 6 åˆ†é˜
- å…è¨±è¼ƒé«˜çš„å¤±æ•—ç‡é–¾å€¼
- è§€å¯Ÿç³»çµ±åœ¨æ¥µé™è² è¼‰ä¸‹çš„è¡Œç‚º

**ä½¿ç”¨å ´æ™¯**:
- å°‹æ‰¾ç³»çµ±ç“¶é ¸
- æ¸¬è©¦ç³»çµ±çš„æ¥µé™æ‰¿å—èƒ½åŠ›
- é©—è­‰é™ç´šå’Œç†”æ–·æ©Ÿåˆ¶

**åŸ·è¡Œå‘½ä»¤**:
```bash
k6 run k6/stress-test.js
```

---

### 4. spike-test.js - å°–å³°æ¸¬è©¦
**ç›®çš„**: æ¸¬è©¦ç³»çµ±æ‡‰å°çªç„¶æµé‡æ¿€å¢çš„èƒ½åŠ›

**ç‰¹é»**:
- æ¨¡æ“¬æµé‡çªç„¶æš´å¢ï¼ˆ10 â†’ 100 â†’ 10 â†’ 150 ç”¨æˆ¶ï¼‰
- å¿«é€Ÿçš„è² è¼‰è®ŠåŒ–ï¼ˆ10ç§’å…§å®Œæˆï¼‰
- è§€å¯Ÿç³»çµ±æ¢å¾©èƒ½åŠ›
- ç¸½é‹è¡Œæ™‚é–“ç´„ 4 åˆ†é˜

**ä½¿ç”¨å ´æ™¯**:
- æ¸¬è©¦è‡ªå‹•æ“´å±•æ©Ÿåˆ¶
- é©—è­‰ç³»çµ±å½ˆæ€§
- æ¨¡æ“¬ä¿ƒéŠ·æ´»å‹•ç­‰çªç™¼æµé‡å ´æ™¯

**åŸ·è¡Œå‘½ä»¤**:
```bash
k6 run k6/spike-test.js
```

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ Makefileï¼ˆæ¨è–¦ï¼Œç„¡éœ€å®‰è£ K6ï¼‰

å°ˆæ¡ˆå·²æ•´åˆ K6 åˆ° Makefile ä¸­ï¼Œä½¿ç”¨ Docker åŸ·è¡Œï¼Œ**ç„¡éœ€æœ¬åœ°å®‰è£ K6**ï¼

```bash
# æŸ¥çœ‹æ‰€æœ‰ K6 æ¸¬è©¦å‘½ä»¤
make k6-help

# å¿«é€Ÿé©—è­‰ç³»çµ±
make k6-smoke

# æ¨™æº–è² è¼‰æ¸¬è©¦
make k6-load

# çªç™¼æµé‡æ¸¬è©¦
make k6-spike

# å£“åŠ›æ¸¬è©¦ï¼ˆæ‰¾å‡ºæ¥µé™ï¼‰
make k6-stress

# æ¸…ç†æ¸¬è©¦çµæœ
make k6-clean
```

**å„ªé»**ï¼š
- âœ… ç„¡éœ€æœ¬åœ°å®‰è£ K6
- âœ… ä½¿ç”¨ Docker åŸ·è¡Œï¼Œç’°å¢ƒä¸€è‡´
- âœ… å‘½ä»¤ç°¡å–®æ˜“è¨˜
- âœ… è‡ªå‹•è™•ç†ç¶²è·¯å’Œå·æ›è¼‰

### æ–¹å¼äºŒï¼šæœ¬åœ°å®‰è£ K6

å¦‚æœä½ æƒ³åœ¨æœ¬åœ°å®‰è£ K6ï¼š

#### å‰ç½®è¦æ±‚

1. **å®‰è£ K6**

   **Linux**:
   ```bash
   sudo gpg -k
   sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
   echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
   sudo apt-get update
   sudo apt-get install k6
   ```

   **macOS**:
   ```bash
   brew install k6
   ```

   **Windows**:
   ```bash
   choco install k6
   ```

   æˆ–ä¸‹è¼‰å®‰è£æª”: https://k6.io/docs/get-started/installation/

2. **ç¢ºèªæœå‹™æ­£åœ¨é‹è¡Œ**
   ```bash
   # æª¢æŸ¥ API Gateway
   curl http://localhost:8080/health

   # æª¢æŸ¥ Service A
   curl http://localhost:8001/health
   ```

### åŸ·è¡Œæ¸¬è©¦

1. **å¾å°ˆæ¡ˆæ ¹ç›®éŒ„åŸ·è¡Œ**:
   ```bash
   # ç…™éœ§æ¸¬è©¦
   k6 run k6/smoke-test.js

   # è² è¼‰æ¸¬è©¦
   k6 run k6/load-test.js

   # å£“åŠ›æ¸¬è©¦
   k6 run k6/stress-test.js

   # å°–å³°æ¸¬è©¦
   k6 run k6/spike-test.js
   ```

2. **ä½¿ç”¨ Docker åŸ·è¡Œ**:
   ```bash
   docker run --rm -i --network=host \
     -v $(pwd)/k6:/scripts \
     grafana/k6:latest run /scripts/load-test.js
   ```

---

## ğŸ“Š æ¸¬è©¦çµæœåˆ†æ

### 1. çµ‚ç«¯è¼¸å‡º
æ‰€æœ‰æ¸¬è©¦è…³æœ¬éƒ½æœƒåœ¨çµ‚ç«¯è¼¸å‡ºæ‘˜è¦å ±å‘Šï¼ŒåŒ…æ‹¬ï¼š
- ç¸½è«‹æ±‚æ•¸
- è«‹æ±‚å¤±æ•—ç‡
- éŸ¿æ‡‰æ™‚é–“çµ±è¨ˆï¼ˆå¹³å‡ã€P95ã€P99ç­‰ï¼‰
- è‡ªå®šç¾©æŒ‡æ¨™

### 2. JSON å ±å‘Š
éƒ¨åˆ†æ¸¬è©¦æœƒç”Ÿæˆ JSON æ ¼å¼çš„è©³ç´°å ±å‘Šï¼š
- `summary.json` - è² è¼‰æ¸¬è©¦å ±å‘Š
- `stress-test-results.json` - å£“åŠ›æ¸¬è©¦å ±å‘Š
- `spike-test-results.json` - å°–å³°æ¸¬è©¦å ±å‘Š

### 3. åœ¨ Grafana ä¸­è§€å¯Ÿ

åŸ·è¡Œæ¸¬è©¦æ™‚ï¼Œå»ºè­°åŒæ™‚åœ¨ Grafana ä¸­è§€å¯Ÿä»¥ä¸‹å…§å®¹ï¼š

1. **æ‰“é–‹ Grafana**: http://localhost:3000

2. **æŸ¥çœ‹ Metrics**:
   - è«‹æ±‚é€Ÿç‡ (RPS)
   - éŸ¿æ‡‰æ™‚é–“åˆ†ä½ˆ
   - éŒ¯èª¤ç‡
   - ç³»çµ±è³‡æºä½¿ç”¨ï¼ˆCPUã€è¨˜æ†¶é«”ï¼‰

3. **æŸ¥çœ‹ Traces**:
   - åœ¨ Explore ä¸­é¸æ“‡ Tempo è³‡æ–™æº
   - æŸ¥çœ‹æ¸¬è©¦æœŸé–“ç”¢ç”Ÿçš„ traces
   - åˆ†ææ…¢è«‹æ±‚å’ŒéŒ¯èª¤è«‹æ±‚

4. **æŸ¥çœ‹ Logs**:
   - åœ¨ Explore ä¸­é¸æ“‡ Loki è³‡æ–™æº
   - ä½¿ç”¨ trace_id é—œè¯æ—¥èªŒå’Œè¿½è¹¤
   - æŸ¥çœ‹éŒ¯èª¤æ—¥èªŒ

---

## ğŸ¯ æ¸¬è©¦å»ºè­°æµç¨‹

å»ºè­°æŒ‰ä»¥ä¸‹é †åºåŸ·è¡Œæ¸¬è©¦ï¼š

1. **ç…™éœ§æ¸¬è©¦** (1 åˆ†é˜)
   ```bash
   k6 run k6/smoke-test.js
   ```
   ç¢ºèªç³»çµ±åŸºæœ¬åŠŸèƒ½æ­£å¸¸

2. **è² è¼‰æ¸¬è©¦** (3.5 åˆ†é˜)
   ```bash
   k6 run k6/load-test.js
   ```
   äº†è§£ç³»çµ±åœ¨æ­£å¸¸è² è¼‰ä¸‹çš„æ€§èƒ½

3. **å°–å³°æ¸¬è©¦** (4 åˆ†é˜)
   ```bash
   k6 run k6/spike-test.js
   ```
   æ¸¬è©¦ç³»çµ±æ‡‰å°çªç™¼æµé‡çš„èƒ½åŠ›

4. **å£“åŠ›æ¸¬è©¦** (6 åˆ†é˜) - å¯é¸
   ```bash
   k6 run k6/stress-test.js
   ```
   æ‰¾å‡ºç³»çµ±çš„æ€§èƒ½æ¥µé™ï¼ˆæ³¨æ„ï¼šå¯èƒ½å½±éŸ¿ç³»çµ±ç©©å®šæ€§ï¼‰

---

## ğŸ”§ é€²éšç”¨æ³•

### 1. è¼¸å‡ºçµæœåˆ°æª”æ¡ˆ
```bash
k6 run --out json=results.json k6/load-test.js
```

### 2. ä½¿ç”¨ç’°å¢ƒè®Šæ•¸
```bash
export BASE_URL=http://your-api-gateway:8080
export SERVICE_A_URL=http://your-service-a:8001
k6 run k6/load-test.js
```

### 3. èª¿æ•´æ¸¬è©¦åƒæ•¸
ç·¨è¼¯æ¸¬è©¦è…³æœ¬ä¸­çš„ `options` ç‰©ä»¶ä¾†èª¿æ•´ï¼š
- è™›æ“¬ç”¨æˆ¶æ•¸ (VUs)
- æ¸¬è©¦æŒçºŒæ™‚é–“
- æ€§èƒ½é–¾å€¼
- æ¸¬è©¦éšæ®µ

### 4. çµåˆ Chaos Testing
```bash
# åœ¨ä¸€å€‹çµ‚ç«¯åŸ·è¡Œ K6 æ¸¬è©¦
k6 run k6/load-test.js

# åœ¨å¦ä¸€å€‹çµ‚ç«¯æ³¨å…¥æ··æ²Œ
make chaos-network-delay
```

---

## ğŸ“ˆ æ€§èƒ½é–¾å€¼èªªæ˜

### ç…™éœ§æ¸¬è©¦
- `http_req_failed` < 1%
- `http_req_duration` P95 < 1000ms

### è² è¼‰æ¸¬è©¦
- `http_req_failed` < 1%
- `http_req_duration` P95 < 2000ms
- `process_success_rate` > 99%

### å£“åŠ›æ¸¬è©¦
- `http_req_failed` < 5%
- `http_req_duration` P95 < 5000ms
- `success_rate` > 90%

### å°–å³°æ¸¬è©¦
- `http_req_failed` < 10%
- `http_req_duration` P90 < 3000ms
- `success_rate` > 85%

---

## ğŸ› å¸¸è¦‹å•é¡Œ

### Q: æ¸¬è©¦å¤±æ•—ç‡å¾ˆé«˜æ€éº¼è¾¦ï¼Ÿ
A:
1. æª¢æŸ¥æœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œ
2. æŸ¥çœ‹ Grafana ä¸­çš„éŒ¯èª¤æ—¥èªŒ
3. å¯èƒ½éœ€è¦èª¿æ•´æœå‹™è³‡æºé…ç½®
4. æª¢æŸ¥è³‡æ–™åº«é€£æ¥æ± å¤§å°

### Q: å¦‚ä½•èª¿æ•´æ¸¬è©¦å¼·åº¦ï¼Ÿ
A: ç·¨è¼¯æ¸¬è©¦è…³æœ¬ä¸­çš„ `stages` é™£åˆ—ï¼Œèª¿æ•´ `target` (è™›æ“¬ç”¨æˆ¶æ•¸) å’Œ `duration` (æŒçºŒæ™‚é–“)

### Q: å¯ä»¥åŒæ™‚é‹è¡Œå¤šå€‹æ¸¬è©¦å—ï¼Ÿ
A: ä¸å»ºè­°ã€‚åŒæ™‚é‹è¡Œæœƒäº’ç›¸å½±éŸ¿æ¸¬è©¦çµæœï¼Œå»ºè­°ä¾åºåŸ·è¡Œã€‚

### Q: æ¸¬è©¦æ™‚ç³»çµ±è³‡æºä¸è¶³æ€éº¼è¾¦ï¼Ÿ
A:
1. æ¸›å°‘è™›æ“¬ç”¨æˆ¶æ•¸
2. å¢åŠ  Docker åˆ†é…çš„è³‡æº
3. ä½¿ç”¨æ›´å¼·å¤§çš„æ©Ÿå™¨
4. åˆ†æ•£æ¸¬è©¦åˆ°å¤šå°æ©Ÿå™¨

---

## ğŸ“š ç›¸é—œè³‡æº

- [K6 å®˜æ–¹æ–‡æª”](https://k6.io/docs/)
- [K6 æ¸¬è©¦é¡å‹](https://k6.io/docs/test-types/introduction/)
- [K6 æŒ‡æ¨™èªªæ˜](https://k6.io/docs/using-k6/metrics/)
- [OpenTelemetry æ–‡æª”](https://opentelemetry.io/docs/)
